/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function LogReader(a,b){"use strict";function c(b){p=b,a?p.root.getDirectory(a,{create:!0},function(a){q=a.createReader(),f()},d):(q=p.root.createReader(),f())}function d(a){log.error("Failed to init FileSystem.")}function e(a,b){v[a].file(function(a){k(a,function(a){b(this.result)})},m)}function f(){q.readEntries(h,i)}function g(a){for(var b=[],c=0;c<v.length;c++){b.push({});for(var d=0;d<a.length;d++)b[c][a[d]]=v[c][a[d]]}return b}function h(a){if(a.length){for(var c=0;c<a.length;c++)a[c].isFile&&v.push(a[c]);f()}else b()}function i(){log.error("Error reading log directory."),b()}function j(a,b){if(v.length)if(r==v.length){var c="Clipper "+Browser.EVERNOTE_VERSION+", "+BUILD_VERSION+"/"+SKITCH_BUILD_VERSION+"\n"+navigator.userAgent+"\n\n";if("arraybuffer"===b){for(var d=new Uint8Array(c.length),e=0;e<c.length;e++)d[e]=c.charCodeAt(e);s.unshift(d.buffer),t+=d.buffer.byteLength;for(var f=new Uint8Array(t),g=0,e=0;e<s.length;e++)f.set(new Uint8Array(s[e]),g),g+=s[e].byteLength;s=f.buffer}else s=c+s;a(s),n()}else{if(0===r&&"arraybuffer"===b&&(s=[]),"arraybuffer"===b){for(var h="\n\n"+v[r].name+"\n",f=new Uint8Array(h.length),e=0;e<h.length;e++)f[e]=h.charCodeAt(e);s.push(f.buffer),t+=f.buffer.byteLength}else s+=v[r].name+"\n";v[r].file(function(c){"arraybuffer"===b?l(c,function(){s.push(this.result),t+=this.result.byteLength,r++,j(a,b)}):k(c,function(){s+=this.result+"\n\n",r++,j(a)})},m)}}function k(a,b){var c=new FileReader;c.onloadend=b,c.readAsText(a)}function l(a,b){var c=new FileReader;c.onloadend=b,c.readAsArrayBuffer(a)}function m(){log.error("readLogFailed."),u=!1}function n(){r=0,s="",u=!1,t=0}function o(a,b){u||(u=!0,j(a,b))}var p,q,r,s,t,u,v=[];n(),webkitRequestFileSystem(PERSISTENT,Log.maxLogSize,c,d),this.getLog=e,this.getLogsProperties=g,this.startExportLogs=o,Object.preventExtensions(this)}function LocalStorageLogReader(){"use strict";function a(a,b){Browser.sendToExtension({name:"main_getLogs"}),d=b}function b(a){return[{name:"current"}]}function c(a,b){a()}var d=null;Browser.addMessageHandlers({receiveLogs:function(a,b,c){a.records&&d&&d(a.records.join("/n"))}}),this.getLog=a,this.getLogsProperties=b,this.startExportLogs=c,Object.preventExtensions(this)}if(window&&window!=window.parent)throw window.location="about:blank",new Error;Object.preventExtensions(LogReader),Object.preventExtensions(LocalStorageLogReader);