/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function getExtensionID(){return chrome.runtime&&chrome.runtime.id?chrome.runtime.id:chrome.i18n.getMessage("@@extension_id")}function traceMSG(a,b,c){if(Browser.debug.traceBrowserMsg){var d=document.location.href.substr(document.location.href.length-15);"string"==typeof b&&b.length>15&&(b=b.substr(b.length-15)),c.name?console.log(d+" "+a,b,c.name,c):console.log(d+" "+a,b,c)}}function initBrowser(){"use strict";Browser.actionClickDisabled=!1,Browser.interceptSpecialKeys=!1,Browser.keyHandlers=[],Browser.debug={traceBrowserMsg:!1,traceChannelMsg:!1},Browser.i18n=chrome.i18n,Browser.extension=chrome.extension,Browser.EVERNOTE_VERSION="6.13",Browser.agent=null,Browser.keyCombos={},Browser.currentKeys={},Browser.safariPopoverVisibilityCheckInterval=0,Browser.browserActionOnClickedListeners=[],Browser.extensionID=SAFARI?"":getExtensionID(),Browser.getMajorVersion=function(){return EDGE?navigator.userAgent.match(/Edge\/(\d+)\./)[1]:SAFARI?navigator.userAgent.match(/Safari\/(\d+)\./)[1]:FIREFOX?navigator.userAgent.match(/Gecko\/(\d+)\./)[1]:navigator.userAgent.match(/(?:Chrome|Chromium)\/(\d+)\./)[1]},Browser.openTab=function(a,b,c){if(SAFARI){var d=safari.application.activeBrowserWindow.openTab();d.url=a,b&&b(d)}else c=c||{},c.url=a,c.active=!0,Number.isInteger(c.windowId)&&chrome.windows.update(c.windowId,{focused:!0}),chrome.tabs.create(c,b)},Browser.closeTab=function(a){SAFARI?a.close():chrome.tabs.remove(a.id)},Browser.setInterceptSpecialKeys=function(a){Browser.interceptSpecialKeys=a},Browser.closeWindow=function(a,b){SAFARI?(a.close(),b&&b()):EDGE?chrome.tabs.remove(a.tabs[0].id,function(){b&&b()}):chrome.windows.remove(a.id,function(){b&&b()})},Browser.focusWindow=function(a){SAFARI?a.activate():chrome.windows.update(a.id,{focused:!0})},Browser.sendToTab=function(a,b,c){if(SAFARI)try{a.page.dispatchMessage(b.name,b)}catch(a){c&&c(a)}else SAFARI||EDGE||!b.toOwnWindow?(traceMSG("TO TAB",a?a.id:null,b),chrome.tabs.sendMessage(a.id,b,c)):(traceMSG("TO OWN",null,b),chrome.runtime.sendMessage(b,c))},Browser.sendToExtension=function(a,b){if(SAFARI)try{safari.self.tab.dispatchMessage(a.name,a)}catch(b){throw console.log("Browser.sendToExtension failed",a.name,b),b}else{traceMSG("TO EXT",0,a);try{chrome.runtime&&chrome.runtime.sendMessage?(b=b||function(){},chrome.runtime.sendMessage(a,b)):chrome.extension.sendMessage(a)}catch(a){if(!b)throw a;b(a)}}},Browser.getAgent=function(){if(Browser.agent)return Browser.agent;var a="Unknown/1.0",b=/^Mozilla\/\d+(\.\d+)*\s+\(.*?([^;()]*(Windows|OS X|Linux)[^;()]*).*?\)/i,c=b.exec(navigator.userAgent);c&&c[2]&&(a=c[2].trim()),a=a.replace(/\s+(\S*\d)/,"/$1");var d="Evernote Webclipper/"+Browser.EVERNOTE_VERSION+" ("+navigator.language+"); "+a+"; ",e="0.0";return SAFARI?(e=navigator.userAgent.replace(/^.*Version\/([0-9.]+).*$/,"$1"),e==navigator.userAgent&&(e="0.0"),d+="Safari/"+e):(e=navigator.userAgent.replace(/^.*Chrome\/([0-9.]+).*$/,"$1"),e==navigator.userAgent&&(e="0.0"),d+="Chrome/"+e),d+=";",Browser.agent=d,Browser.agent},Browser.removeMessageHandlers=function(){if(SAFARI){var a=null;a=safari.application?safari.application:safari.self;for(var b=0;b<Browser.messageListeners.length;b++)a.removeEventListener("message",Browser.messageListeners[b],!1)}Browser.messageListeners=[]},Browser.addMessageHandlers=function(a,b){var c;if(SAFARI){if("about:blank"==document.location.href)return;if(!b&&window&&window.parent!=window){var d=chrome.extension.getURL("");if(document.location.href.substr(0,d.length)!=d)return}var e=null;if(!safari)return void log.warn("No 'safari' object.");e=safari.application?safari.application:safari.self,c=function(b){b.name&&a[b.name]&&a[b.name](b.message,{tab:b.target},null)},e.addEventListener("message",c,!1)}else c=function(b,c,d){return!c||c.id!==Browser.extensionID&&c.sender&&c.sender.id!==Browser.extensionID?void log.warn("Got request from unexpected sender. Ignoring."):(b.name&&a[b.name]?(traceMSG("HA MSG",c.url,b),a[b.name](b,c,d)):traceMSG("UH MSG",c.url,b),!!d||void 0)},chrome.runtime.onMessage?chrome.runtime.onMessage.addListener(c):chrome.extension.onMessage.addListener(c);Browser.messageListeners.push(c)},Browser.addKeyboardHandlers=function(a){for(var b in a)Browser.keyCombos[b]=a[b]},Browser.handleKeys=function(a){var b=[];for(var c in Browser.currentKeys)b.push(parseInt(c));b.sort(function(a,b){return a-b});var d=b.join(" + ");Browser.keyCombos[d]&&Browser.keyCombos[d](d,a),Browser.currentKeys={}},Browser.setIcon=function(a){if(SAFARI){a="images/ext_icons/safari/"+a;for(var b in safari.extension.toolbarItems){var c=safari.extension.toolbarItems[b];"clipper"==c.identifier&&(c.image=safari.extension.baseURI+a+"-16x16.png")}}else{a="images/ext_icons/"+a;var d={19:chrome.extension.getURL(a+"-19x19.png"),20:chrome.extension.getURL(a+"-20x20.png"),38:chrome.extension.getURL(a+"-19x19@2x.png"),40:chrome.extension.getURL(a+"-40x40.png")};FIREFOX&&(d[16]=chrome.extension.getURL(a+"-16x16.png"),d[32]=chrome.extension.getURL(a+"-16x16@2x.png")),chrome.browserAction.setIcon({path:d})}},Browser.plurr=window.Plurr?new Plurr({locale:getPlurrLocale()}):null,Browser.getExtensionURL=function(a){var a=a||"";return SAFARI?safari.extension.baseURI+a:chrome.extension.getURL(a)},Browser.getAcceptLanguages=function(a){SAFARI?a([navigator.language]):chrome.i18n.getAcceptLanguages(a)},Browser.setTitle=function(a){if(SAFARI)for(var b in safari.extension.toolbarItems){var c=safari.extension.toolbarItems[b];"clipper"==c.identifier&&(c.toolTip=a)}else EDGE||chrome.browserAction.setTitle({title:a})},Browser.clickHandler=null,Browser.safariCommandWrapper=function(a){if("clipper"==a.command)for(var b=safari.extension.toolbarItems,c=0;c<b.length;c++)if("clipper"==b[c].identifier){Browser.clickHandler&&Browser.clickHandler(a.target.browserWindow.activeTab);break}},Browser.setBrowserActionClickHandler=function(a){if(Browser.removeBrowserActionClickHandler(),Browser.clickHandler=a,SAFARI){safari.application.addEventListener("command",Browser.safariCommandWrapper,!1)}else chrome.browserAction.onClicked&&chrome.browserAction.onClicked.addListener(Browser.clickHandler)},Browser.removeBrowserActionClickHandler=function(){SAFARI?safari.application.removeEventListener("command",Browser.safariCommandWrapper,!1):Browser.clickHandler&&null!==Browser.clickHandler&&chrome.browserAction.onClicked.removeListener(Browser.clickHandler),Browser.clickHandler=null},Browser.insertJS=function(a,b){SAFARI?(safari.extension.addContentScriptFromURL(safari.extension.baseURI+a),b&&b()):b?chrome.tabs.executeScript(null,{file:a},b):chrome.tabs.executeScript(null,{file:a})},Browser.insertCSS=function(a,b){SAFARI?(safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI+a),b&&b()):b?chrome.tabs.insertCSS(null,{file:a},b):chrome.tabs.insertCSS(null,{file:a})},Browser.captureVisibleTab=function(a,b){SAFARI?a.visibleContentsAsDataURL(b):chrome.tabs.captureVisibleTab(a.windowId,{format:"png"},b)},Browser.getCurrentTab=function(a){return new Promise(function(b){var c=function(c){"function"==typeof a&&a(c),b(c)};if(SAFARI){var d=safari.application.activeBrowserWindow.activeTab;d.id||(d.id=Math.floor(1e5*Math.random())),c(d)}else chrome.tabs.query({active:!0,currentWindow:!0},function(a){a&&a.length>0?c(a[0]):(log.warn("chrome tabs query did not return a result while getting current tab"),c())})})},Browser.getAllTabs=function(a){if(SAFARI){for(var b=safari.application.browserWindows,c=[],d=0;d<b.length;d++)for(var e=0;e<b[d].tabs.length;e++)c.push(b[d].tabs[e]);a(c)}else chrome.tabs.query({},a)},Browser.overrideScroll=function(a){var b=a.wheelDelta||-a.detail;this.scrollTop+=(b<0?1:-1)*Math.abs(a.wheelDeltaY),a.preventDefault()},Browser.pushKeyHandler=function(a){Browser.keyHandlers.push(a)},Browser.popKeyHandler=function(a){var b=Browser.keyHandlers.indexOf(a);-1===b&&log.error("Could not pop key handler"),Browser.keyHandlers.splice(b,1)},window.addEventListener("keydown",function(a){if(FIREFOX&&191==a.keyCode&&Browser.interceptSpecialKeys&&a.preventDefault(),Browser.keyHandlers.length)return void Browser.keyHandlers[Browser.keyHandlers.length-1](a);189==a.keyCode&&a.altKey?Browser.currentKeys[76]=a:188==a.keyCode&&a.altKey?Browser.currentKeys[80]=a:190==a.keyCode&&a.altKey?Browser.currentKeys[88]=a:Browser.currentKeys[a.keyCode]=a},!0),window.addEventListener("keyup",function(a){Browser.handleKeys(a.target)}),Browser.runAfterDomLoaded=function(a){var b=document.readyState;"uninitialized"!=b&&"loading"!=b?a():window.addEventListener("DOMContentLoaded",a)},Browser.whichTransitionEnd=function(){return FIREFOX||EDGE?"transitionend":"webkitTransitionEnd"},Browser.whichAnimationEnd=function(){return FIREFOX||EDGE?"animationend":"webkitAnimationEnd"},Browser.setupL10n=function(){return Browser._l10nPromise||(Browser._l10nPromise=platform.channel.sendMessage("getL10nData").then(function(a){Browser.i18n._setL10nData(a),Browser.extensionID=getExtensionID()})),Browser._l10nPromise},Browser.isExtensionWindow=window===window.parent&&("chrome-extension:"===location.protocol||"moz-extension:"===location.protocol||"ms-browser-extension:"===location.protocol),Browser.isExtension=function(){return!!window&&(window.safari?!!safari.application:!!window.chrome&&(Browser.isExtensionWindow&&"/background.html"===location.pathname))}(),Object.preventExtensions(Browser)}var Browser={};Browser.messageListeners=[],Browser._l10nPromise=null,getPlurrLocale=function(){var a=chrome.i18n.getUILanguage().split("-");return 1==a.length&&(a=chrome.i18n.getUILanguage().split("_")),a[0]},initBrowser();var platform=function(){function a(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})}function b(){Browser.isExtension?this.channel=new d:this.channel=new c}var c=function(){function b(){this.guid=a(),this.uniqueMessageID=1,this.pendingMessages={},Browser.debug.traceChannelMsg&&console.log("ContentChannel created",this.guid),Object.preventExtensions(this)}return b.prototype.sendMessage=function(a,b){var c=this.uniqueMessageID++,d=this;return new Promise(function(e,f){Browser.debug.traceChannelMsg&&console.log("ContentChannel sendMessage",c,a,b),d.pendingMessages[c]={message:a,resolve:e,reject:f},Browser.sendToExtension({name:"dispatchPromise",id:d.guid+"/"+c,message:a,payload:b,toOwnWindow:Browser.isExtensionWindow},null)})},b.prototype.dispatchResponse=function(a,b,c){if(Browser.debug.traceChannelMsg&&(a.resolved?console.log("ContentChannel got response",a.id.split("/")[1],a.payload,a.toOwnWindow):console.log("ContentChannel got ERROR",a.id.split("/")[1],a.reason,a.toOwnWindow)),!a.id)return void log.error("Request has no id: ",a);var d=a.id.split("/");if(d[0]==this.guid){var e=d[1],f=this.pendingMessages[e];if(!f)return void log.error("Can't find request for response: ",a);delete this.pendingMessages[e],a.resolved?f.resolve(a.payload):(log.error(f.message+" failed: "+a.reason),f.reject(a.reason))}},b}(),d=function(){function a(){Browser.debug.traceChannelMsg&&console.log("ExtensionChannel created"),this.registeredHandlers={}}return a.prototype.registerHandler=function(a,b){if(this.registeredHandlers[a])return void log.error("Handler is already registered for message: ",a);this.registeredHandlers[a]=b},a.prototype.registerHandlers=function(a){Object.keys(a).forEach(function(b){this.registerHandler(b,a[b])},this)},a.prototype.unregisterHandler=function(a){if(!this.registeredHandlers[a])return void log.error("Handler is not yet registered for message: ",a);delete this.registeredHandlers[a]},a.prototype.dispatchPromise=function(a,b,c){function d(c){Browser.debug.traceChannelMsg&&console.log("ExtensionChannel rsponse",a.id,c,a.toOwnWindow),Browser.sendToTab(b.tab,{name:"dispatchResponse",id:a.id,toOwnWindow:a.toOwnWindow,resolved:!0,payload:c})}function e(c){Browser.debug.traceChannelMsg&&console.log("ExtensionChannel got ERR",a.id,a.reason,a.toOwnWindow),Browser.sendToTab(b.tab,{name:"dispatchResponse",id:a.id,toOwnWindow:a.toOwnWindow,resolved:!1,reason:c})}var f=this.registeredHandlers[a.message];if(!f)return log.error("Handler is not yet registered for message: "+a.message),void e();Browser.debug.traceChannelMsg&&console.log("ExtensionChannel request",a.id,a.message,a.toOwnWindow),f(a.payload,d,e)},a}(),e=new b;return Browser.isExtension?Browser.addMessageHandlers({dispatchPromise:e.channel.dispatchPromise.bind(e.channel)}):Browser.addMessageHandlers({dispatchResponse:e.channel.dispatchResponse.bind(e.channel)}),e}();SAFARI&&!Browser.isExtension&&Browser.setupL10n();