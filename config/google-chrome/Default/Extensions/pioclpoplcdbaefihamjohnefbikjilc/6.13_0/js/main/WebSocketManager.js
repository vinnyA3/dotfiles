/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function WebSocketManager(a,b,c){"use strict";function d(a){s[a.id]=a,t.readyState!==WebSocket.CLOSING&&t.readyState!==WebSocket.CLOSED||n()}function e(){l();var a=new RealTimeRequest;a.realTimeAuthentication=new RealTimeAuthentication,a.realTimeAuthentication.authenticationToken=b,a.write(p);var c=o.flush(!0);t.send(c.buffer)}function f(){return b}function g(){return a}function h(){return Object.keys(s).map(function(a){return s[a]})}function i(){return t.readyState===WebSocket.CLOSED||t.readyState===WebSocket.CLOSING}function j(a){clearTimeout(q),l(),o.write(new Uint8Array(a)),o.received=a;var b=new RealTimeNotification;b.read(p),b.authenticationResult&&(r=1e3*b.authenticationResult.pingFrequency),q=setTimeout(m,r),c(b)}function k(a){delete s[a.id],Object.keys(s).length||(clearTimeout(q),t.close())}function l(){o=new Thrift.BinaryHttpTransport,p=new Thrift.BinaryProtocol(o)}function m(){if(i())n();else{l();var a=new RealTimeRequest;a.realTimePing=new RealTimePing,a.write(p);var b=o.flush(!0);t.send(b.buffer)}}function n(){var a=extension.getBootstrapInfo("serviceHost");t="localhost:8080"===a?new WebSocket("ws://"+a+"/ws/shard/"+accountManager.currentUserInfo.shardId+"/id"):new WebSocket(accountManager.currentUserInfo.urls.userWebSocketUrl),t.addEventListener("open",function(){this.binaryType="arraybuffer",this.addEventListener("message",function(a){j(a.data)}),e()})}var o,p,q,r=3e5,s={},t=null;n(),this.addTabs=d,this.getAuthToken=f,this.getShardId=g,this.getTabs=h,this.isClosed=i,this.removeTab=k,Object.preventExtensions(this)}Object.preventExtensions(WebSocketManager);