/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function copyText(){if(EDGE||FIREFOX){document.getElementById("shareLink").select(),urlCopied({copied:document.execCommand("Copy",!1,null)})}else Browser.sendToExtension({name:"copyText",text:shareLink.value})}function doneSharing(a,b,c){"linkedin"===shareType?document.location.href="http://www.linkedin.com/shareArticle?mini=true&url="+encodeURIComponent(a.url)+"&title="+title:"weibo"===shareType?document.location.href="http://service.weibo.com/share/share.php?url="+encodeURIComponent(a.url)+"&title="+title+"&pic="+encodeURIComponent(a.url+"/thm/note/"+noteGuid):"facebook"===shareType?document.location.href="https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(a.url):"twitter"===shareType?document.location.href="https://twitter.com/intent/tweet?text="+title+"&url="+encodeURIComponent(a.url):"gplus"===shareType?document.location.href="https://plus.google.com/share?url="+encodeURIComponent(a.url):"url"===shareType&&(document.body.classList.add("url"),shareLink.value=a.url),c&&"function"==typeof c&&c()}function emailNote(){if(!send.classList.contains("disabled")){for(var a=recipients.value.split(/\s*,\s*/),b=0;b<a.length;b++)""===a[b].trim()&&a.splice(b,1);Browser.sendToExtension({name:"emailNote",noteStoreUrl:noteStoreUrl,message:message.value,shardId:shardId,token:token,noteGuid:noteGuid,recipients:a}),Browser.sendToExtension({name:"trackEvent",category:"Share",action:"email_completed",label:message.value.trim()?"added_message":"no_message",value:a.length}),Browser.sendToExtension({name:"main_closeSenderWindow"})}}function handleRecipientsInput(){showAutocomplete();for(var a=recipients.value.split(/\s*,\s*/),b=new RegExp(EDAM_EMAIL_REGEX),c=!0,d=0;d<a.length;d++)if(""!==a[d]){if(!b.test(a[d]))return send.classList.add("disabled"),void send.classList.remove("green");c=!1}c?(send.classList.add("disabled"),send.classList.remove("green")):(send.classList.remove("disabled"),send.classList.add("green"))}function receiveContacts(a,b,c){if(a.count===findContactsCount){contacts.innerHTML="";for(var d=0;d<a.contacts.length;d++){var e=document.createElement("div");e.classList.add("contact"),a.contacts[d].name?e.innerText=a.contacts[d].name+" ("+a.contacts[d].email+")":e.innerText=a.contacts[d].email,e.setAttribute("email",a.contacts[d].email),e.addEventListener("click",function(){var a=recipients.value.lastIndexOf(",",recipients.selectionStart-1),b=recipients.value.indexOf(",",recipients.selectionStart-1);b<0&&(b=recipients.value.length),recipients.value=recipients.value.substring(0,a+1)+this.getAttribute("email")+","+recipients.value.substring(b+1),handleRecipientsInput.call(recipients),recipients.focus()}),contacts.appendChild(e)}}c&&"function"==typeof c&&c()}function showAutocomplete(){clearTimeout(autoCompleteTimeout);var a=recipients.value.lastIndexOf(",",recipients.selectionStart-1),b=recipients.value.indexOf(",",recipients.selectionStart-1);b<0&&(b=recipients.value.length);var c=recipients.value.slice(a+1,b);findContactsCount++,c.trim()?autoCompleteTimeout=setTimeout(function(a){return function(){Browser.sendToExtension({name:"findContacts",prefix:a,count:findContactsCount})}}(c.trim()),300):contacts.innerHTML=""}function urlCopied(a,b,c){a.copied?document.body.classList.add("urlCopied"):document.body.classList.remove("urlCopied"),c&&"function"==typeof c&&c()}var noteGuid=decodeURIComponent(/guid=([^&]+)/.exec(document.location.search)[1]),shareType=/shareType=([^&]+)/.exec(document.location.search)[1],title=/title=([^&]+)/.exec(document.location.search)[1],tokenMatch=/token=([^&]+)/.exec(document.location.search),token=tokenMatch&&tokenMatch[1]?decodeURIComponent(tokenMatch[1]):"",noteStoreUrl=decodeURIComponent(/noteStoreUrl=([^&]+)/.exec(document.location.search)[1]),shardId=decodeURIComponent(/shardId=([^&]+)/.exec(document.location.search)[1]),recipients,contacts,message,send,shareLink,copy,autoCompleteTimeout,findContactsCount=0;window.addEventListener("DOMContentLoaded",function(){if(document.body.classList.add(shareType),recipients=document.getElementById("recipients"),contacts=document.getElementById("contacts"),message=document.getElementById("message"),send=document.getElementById("send"),shareLink=document.getElementById("shareLink"),copy=document.getElementById("copy"),GlobalUtils.localize(document.documentElement),document.getElementById("title").innerText=decodeURIComponent(title),recipients.placeholder=Browser.i18n.getMessage("enterEmailAddresses"),message.placeholder=Browser.i18n.getMessage("addAMessage"),recipients.addEventListener("input",handleRecipientsInput),send.addEventListener("click",emailNote),shareLink.addEventListener("focus",function(){this.select()}),shareLink.addEventListener("mouseup",function(a){a.preventDefault()}),shareLink.addEventListener("copy",function(){document.body.classList.add("urlCopied")}),copy.addEventListener("click",copyText),SAFARI){var a=parseInt(/width=([^&]+)/.exec(document.location.search)[1]),b=parseInt(/height=([^&]+)/.exec(document.location.search)[1]);window.resizeTo(window.outerWidth-window.innerWidth+a,window.outerHeight-window.innerHeight+b),copy.style.display="none"}"email"!==shareType&&Browser.sendToExtension({name:"shareNote",guid:noteGuid,shareType:shareType,noteStoreUrl:noteStoreUrl,token:token})}),Browser.addMessageHandlers({sh_complete:doneSharing,sh_receiveContacts:receiveContacts,sh_urlCopied:urlCopied});