/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function countSerializableFrames(){for(var a=document.getElementsByTagName("iframe"),b=0,c=0;c<a.length;c++)a[c].dataset&&a[c].dataset.en_id&&b++;return b}function completedFrameCount(){var a=0;for(var b in frameData)a++;return a}function isAlive(a,b,c){Browser.sendToExtension({name:"isAlive",message:{name:"frame_loader"}}),c&&"function"==typeof c&&c()}if(window.self==top.self){var frameData={},completed=!1,addedEventListeners=!1,timeout,serializeFrames=function(a,b){function c(){completed||(log.warn("Some frames seem stuck, continuing with what we've got."),completed=!0,a(frameData))}if(0==countSerializableFrames())return void a(null);addedEventListeners||(window.addEventListener("message",function(b){b&&b.data&&b.data.name&&"EN_serialized"==b.data.name?(frameData[b.data.id]=b.data.data,clearTimeout(timeout),completed||(completedFrameCount()==countSerializableFrames()?(completed=!0,a(frameData)):timeout=setTimeout(c,3e3))):b&&b.data&&b.data.name&&"main_getTextResource"==b.data.name&&Browser.sendToExtension({name:"main_getTextResource",href:b.data.href})},!1),addedEventListeners=!0),frameData={},completed=!1,timeout=setTimeout(c,3e3),Browser.sendToExtension({name:"bounce",message:{name:"startSerialize",config:b}})};Browser.addMessageHandlers({content_textResource:function(a,b,c){window.postMessage(a,"*"),c&&"function"==typeof c&&c()}})}else Browser.addMessageHandlers({startSerialize:function(a,b,c){if(JSON.stringify){var d=document.createElement("script");d.type="text/javascript",d.textContent="var config = "+JSON.stringify(a.config)+"; if(window.serializeFrame){serializeFrame()};",document.head.appendChild(d)}c&&"function"==typeof c&&c()}},!0);var addedScripts=!1;Browser.addMessageHandlers({insertSerializationScripts:function(a,b,c){var d=function(a){if(document.head&&!document.querySelector("script[src='"+Browser.extension.getURL(a)+"']")){var b=document.createElement("script");b.type="text/javascript",b.src=Browser.extension.getURL(a),document.head.appendChild(b)}};window!=window.parent&&(addedScripts||(d("third_party/port.js"),d("js/GlobalUtils.js"),d("content/HtmlSerializer.js"))),addedScripts||(d("content/frame.js"),addedScripts=!0),c&&"function"==typeof c&&c()},contextIsAlive:isAlive},!0);