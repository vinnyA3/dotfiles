/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function addContact(a){recipientInput.addLozengeAndClearInput(a),a.type===ContactType.EMAIL&&Browser.sendToExtension({name:"findContactByEmail",email:a.id}),enableSendButtonIfNeeded()}function clearSection(a){if(a===suggestedChats)threadInfo={};else if(a===suggestedContacts)contactInfo={};else if(a===selectedThread){persistThreadReadStatus(),messageInfo={};for(var b in selectedThread.dataset)delete selectedThread.dataset[b];originalLastReadMessageId=null,setWindowTitle()}a.innerHTML=""}function coalesceParticipantChangeEvents(a,b,c){for(var d=b;d<a.length&&a[d].changeType===a[b].changeType&&a[d].sender.id==a[b].sender.id&&a[d].time<a[b].time+PARTICIPANT_CHANGE_EVENTS_COALESCE_TIME_THRESHOLD;)a[d].changeValue?c.push(a[d].changeValue):c.push.apply(c,a[d].attachments),d++;return d-1}function enableSendButtonIfNeeded(){recipientInput.getLozenges().length?document.body.classList.contains("noShareNote")?newMessage.value.trim()?sendButton.disabled=!1:sendButton.disabled=!0:sendButton.disabled=!1:sendButton.disabled=!0}function formatDate(a){var b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],c=["Jan","Feb","March","April","May","June","July","Aug","Sept","Oct","Nov","Dec"],d=Browser.i18n.getMessage("workchatDateFormat"),e=new Date(a);return e.getFullYear()===(new Date).getFullYear()&&(d=Browser.i18n.getMessage("workchatDateFormatThisYear")),d.replace(/(\W|^)EEE(\W|$)/,"$1"+Browser.i18n.getMessage(b[e.getDay()])+"$2").replace(/(\W|^)MMM(\W|$)/,"$1"+Browser.i18n.getMessage(c[e.getMonth()])+"$2").replace(/(\W|^)d(\W|$)/,"$1"+e.getDate()+"$2").replace(/(\W|^)yyyy(\W|$)/,"$1"+e.getFullYear()+"$2").replace(/(\W|^)h(\W|$)/,"$1"+((e.getHours()+11)%12+1)+"$2").replace(/(\W|^)mm(\W|$)/,"$1"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+"$2").replace(/(\W|^)a(\W|$)/,"$1"+(e.getHours()>=12?Browser.i18n.getMessage("PM"):Browser.i18n.getMessage("AM"))+"$2")}function generateThreadChangeI18nVariation(a,b,c){var d={key:"workchat",placeholders:[]},e=getContactName(b);if(b.self?d.key+="You":e?d.placeholders.push(GlobalUtils.escapeXML(e)):d.key+="Unknown",d.key+=a,"object"==typeof c){var f=[],g=0,h=!1,i=0,j=0;for(var k in c)if(c[k].type)c[k].type===MessageAttachmentType.NOTE?i++:c[k].type===MessageAttachmentType.NOTEBOOK&&j++;else{var l=getContactName(c[k]);c[k].self&&(h=!0),l?f.push(GlobalUtils.escapeXML(l)):g++}if(h&&1===f.length&&!g)d.key+="You";else{if(f.length>=1){if(1!==f.length||g)if(d.key+="Many",g)d.placeholders.push(f.join(", "));else{var m=f.pop();d.placeholders.push(f.join(", ")),d.placeholders.push(m)}else d.key+="One",d.placeholders.push(f[0]);d.key+="Known"}g>=1&&(1===g?d.key+="One":(d.key+="Many",d.placeholders.push(g)),d.key+="Unknown")}i>=1&&(d.key+=1===i?"One":"Many",d.key+="Note"),j>=1&&(d.key+=1===j?"One":"Many",d.key+="Notebook")}else"string"==typeof c&&d.placeholders.push(GlobalUtils.escapeXML(c));return d}function getContactName(a){return a.name||a.email}function hideIfEmpty(a,b){a.children.length&&!b?a.parentNode.classList.add("hasContent"):a.parentNode.classList.remove("hasContent");for(var c=0;c<suggestions.children.length;c++){if(suggestions.children[c].classList.contains("hasContent")){suggestions.classList.add("hasContent");break}suggestions.classList.remove("hasContent")}}function highlightOnlyMatch(){if(suggestedContacts.children.length+suggestedChats.children.length===1){(suggestedContacts.firstElementChild||suggestedChats.firstElementChild).classList.add("hover")}else{for(var a=suggestedContacts.getElementsByClassName("hover"),b=suggestedChats.getElementsByClassName("hover");a.length;)a[0].classList.remove("hover");for(;b.length;)b[0].classList.remove("hover")}}function isGoogleConnected(a,b,c){a.connected?findContacts.classList.remove("google","hasContent"):(findContacts.classList.add("google","hasContent"),connectGoogle.href=a.connectUrl,connectGoogle.addEventListener("click",function(){Browser.sendToExtension({name:"wbg_invalidateGoogleContacts"})})),c&&"function"==typeof c&&c()}function markVisibleMessagesAsRead(){for(var a=selectedThread.getElementsByClassName("unread");a.length>0;){var b=a[0];if(b.offsetTop>=selectedThread.scrollTop+selectedThread.offsetHeight)break;b.classList.remove("unread"),clearTimeout(persistThreadReadStatusTimeout),persistThreadReadStatusTimeout=setTimeout(persistThreadReadStatus,1e4)}}function messageSyncComplete(a,b,c){searchChatsAndContacts(""),c&&"function"==typeof c&&c()}function needSendConfirmation(){if(!document.body.classList.contains("noShareNote")&&notebookType==GlobalUtils.NOTEBOOK_TYPE_BUSINESS)for(var a=recipientInput.getLozenges(),b=0;b<a.length;b++)if(!a[b].sameBusiness)return!0;return!1}function openThread(a,b){var c={name:"getMessagesOfThread",threadId:a};if(b)for(var d in b)c[d]=b[d];Browser.sendToExtension(c),Browser.sendToExtension({name:"getMetadataOfThread",threadId:a})}function openThreadWithSelectedContacts(a){a||(a={}),a.name="findThreadByGivenContacts",a.contacts=recipientInput.getLozenges(),Browser.sendToExtension(a)}function persistThreadReadStatus(){if(clearTimeout(persistThreadReadStatusTimeout),selectedThread.dataset.threadId){var a=selectedThread.getElementsByClassName("unread")[0];if(a){var b=a.previousElementSibling;if(!b.classList.contains("message")){var c=b.parentNode.previousElementSibling;c&&(b=c.lastElementChild)}b.classList.contains("message")&&originalLastReadMessageId!=b.dataset.id&&Browser.sendToExtension({name:"updateThreadReadStatus",messageId:b.dataset.id,threadId:selectedThread.dataset.threadId})}else{var d=selectedThread.lastElementChild;if(d){var e=d.lastElementChild;e&&originalLastReadMessageId!=e.dataset.id&&Browser.sendToExtension({name:"updateThreadReadStatus",messageId:e.dataset.id,threadId:selectedThread.dataset.threadId})}}}}function receiveContacts(a,b,c){if(a.contactSearchNum>newestContactSearchReceived){newestContactSearchReceived=a.contactSearchNum,clearSection(suggestedContacts);for(var d=0;d<a.contacts.length;d++)if(!recipientInput.hasLozenge(a.contacts[d].id)){if(suggestedContacts.children.length>=MAX_CONTACTS_TO_SHOW)break;var e=document.createElement("div");e.classList.add("contact"),e.dataset.id=a.contacts[d].id,a.contacts[d].sameBusiness?e.classList.add("sameBusiness"):a.contacts[d].google&&e.classList.add("google"),contactInfo[e.dataset.id]=a.contacts[d],contactInfo[e.dataset.id].name=getContactName(contactInfo[e.dataset.id]),e.addEventListener("click",function(){selectSearchResult(),addContact(contactInfo[this.dataset.id]),openThreadWithSelectedContacts(),recipientInput.focus()}),e.addEventListener("mouseenter",function(){this.classList.add("hover")}),e.addEventListener("mouseleave",function(){this.classList.remove("hover")});var f=document.createElement("img");a.contacts[d].photoUrl?(f.dataset.thumbnailNumber=thumbnailNumber++,a.contacts[d].google?Browser.sendToExtension({name:"downloadThumbnail",guid:f.dataset.thumbnailNumber,method:"GET",url:a.contacts[d].photoUrl}):Browser.sendToExtension({name:"downloadThumbnail",guid:f.dataset.thumbnailNumber,method:"GET",size:32,url:a.contacts[d].photoUrl})):devicePixelRatio>1?f.src=Browser.extension.getURL("images/workchat-no-photo@2x.png"):f.src=Browser.extension.getURL("images/workchat-no-photo.png");var g=document.createElement("div");g.classList.add("container");var h=document.createElement("div");h.textContent=getContactName(a.contacts[d]),h.classList.add("name");var i=document.createElement("div");i.classList.add("details"),i.textContent=a.contacts[d].role||a.contacts[d].email,g.appendChild(h),g.appendChild(i),e.appendChild(f),e.appendChild(g),suggestedContacts.appendChild(e)}hideIfEmpty(suggestedContacts),highlightOnlyMatch(),a.contacts.length?Browser.sendToExtension({name:"findThreads",contacts:a.contacts,nameQuery:a.query,requiredContacts:recipientInput.getLozenges(),contactSearchNum:a.contactSearchNum}):Browser.sendToExtension({name:"findThreads",nameQuery:a.query,contactSearchNum:a.contactSearchNum}),c&&"function"==typeof c&&c()}}function receiveMessagesOfThread(a,b,c){var d=null,e=null,f=0;if(a.update){if(a.updateViewNum&&a.updateViewNum<updateViewNum)return;if(d=selectedThread.lastElementChild){var g=messageInfo[d.lastElementChild.dataset.id];e=g.sender.id,f=g.time}for(var h=selectedThread.getElementsByClassName("unread");h.length&&h[0].dataset.id<=a.lastReadMessageId;)h[0].classList.remove("unread")}else clearSection(selectedThread);selectedThread.dataset.threadId=a.threadId,originalLastReadMessageId=a.lastReadMessageId;for(var i=0;i<a.messages.length;i++){if(a.messages[i].sender.id!=e||a.messages[i].time>=f+12e5||a.messages[i].changeType||a.messages[i].reshareMessage){d=document.createElement("div"),d.classList.add("messageTurn");var j=document.createElement("div");j.classList.add("sender");var k=document.createElement("img");k.classList.add("photo"),a.messages[i].sender.photoUrl?(k.dataset.thumbnailNumber=thumbnailNumber++,Browser.sendToExtension({name:"downloadThumbnail",guid:k.dataset.thumbnailNumber,method:"GET",size:32,url:a.messages[i].sender.photoUrl})):devicePixelRatio>1?k.src=Browser.extension.getURL("images/workchat-no-photo@2x.png"):k.src=Browser.extension.getURL("images/workchat-no-photo.png"),j.appendChild(k);var l=document.createElement("div");l.classList.add("name"),l.textContent=a.messages[i].sender.name,j.appendChild(l);var m=document.createElement("div");m.classList.add("messageTime"),m.textContent=formatDate(a.messages[i].time),j.appendChild(m),a.messages[i].sender.self&&d.classList.add("self"),d.appendChild(j),selectedThread.appendChild(d),e=a.messages[i].sender.id}if(messageInfo[a.messages[i].id]=a.messages[i],a.messages[i].changeType||a.messages[i].reshareMessage){f=0;var n=document.createElement("div");n.classList.add("threadChange");var o={};if(a.messages[i].changeType===MessageThreadChangeType.PARTICIPANT_ADDED){var p=[];i=coalesceParticipantChangeEvents(a.messages,i,p),o=generateThreadChangeI18nVariation("AddedParticipant",a.messages[i].sender,p)}else if(a.messages[i].changeType===MessageThreadChangeType.PARTICIPANT_REMOVED){var p=[];i=coalesceParticipantChangeEvents(a.messages,i,p),o=generateThreadChangeI18nVariation("RemovedParticipant",a.messages[i].sender,p)}else a.messages[i].changeType===MessageThreadChangeType.MESSAGE_THREAD_RENAMED?o=generateThreadChangeI18nVariation("ChangedThreadName",a.messages[i].sender,a.messages[i].changeValue):a.messages[i].reshareMessage&&(o=generateThreadChangeI18nVariation("Reshared",a.messages[i].sender,a.messages[i].attachments));n.innerHTML=Browser.i18n.getMessage(o.key,o.placeholders),d.appendChild(n),2===d.children.length&&d.classList.add("startsWithThreadChange")}else{f=a.messages[i].time;var q=document.createElement("div");q.classList.add("message"),q.dataset.id=a.messages[i].id,a.messages[i].id>a.lastReadMessageId&&q.classList.add("unread");var r=document.createElement("div");if(r.classList.add("inner"),a.messages[i].body){var s=document.createElement("div");s.classList.add("body"),s.innerHTML=a.messages[i].body,r.appendChild(s)}for(var t in a.messages[i].attachments){var u=document.createElement("a");u.target="_blank",a.messages[i].attachments[t].type===MessageAttachmentType.NOTE?u.href=a.baseUrl+"/MessageAttachmentDispatch.action?type=NOTE&guid="+a.messages[i].attachments[t].guid+"&userId="+a.messages[i].attachments[t].userId+"&shardId="+a.messages[i].attachments[t].shardId:a.messages[i].attachments[t].type===MessageAttachmentType.NOTEBOOK&&(u.href=a.baseUrl+"/MessageAttachmentDispatch.action?type=NOTEBOOK&title="+encodeURIComponent(a.messages[i].attachments[t].title)+"&guid="+a.messages[i].attachments[t].guid+"&userId="+a.messages[i].attachments[t].userId+"&shardId="+a.messages[i].attachments[t].shardId),u.classList.add("attachment"),u.textContent=a.messages[i].attachments[t].title,a.messages[i].attachments[t].type===MessageAttachmentType.NOTE?u.classList.add("note"):a.messages[i].attachments[t].type===MessageAttachmentType.NOTEBOOK&&u.classList.add("notebook"),r.appendChild(u)}q.appendChild(r),d.appendChild(q)}}var v=selectedThread.getElementsByClassName("unread")[0];v?v.previousElementSibling.classList.contains("sender")?selectedThread.scrollTop=v.parentNode.offsetTop:selectedThread.scrollTop=v.offsetTop:selectedThread.scrollTop=selectedThread.scrollHeight-(selectedThread.offsetHeight-1),markVisibleMessagesAsRead(),c&&"function"==typeof c&&c()}function receiveMetadataOfThread(a,b,c){setWindowTitle(a.title),recipientInput.removeAllLozengesOnly();for(var d=a.participants,e=0;e<d.length;e++)addContact(d[e]);c&&"function"==typeof c&&c()}function receiveThreads(a,b,c){if(a.contactSearchNum===newestContactSearchReceived){clearSection(suggestedChats);for(var d=0;d<a.threads.length;d++){var e=document.createElement("div");if(e.classList.add("existingThread"),e.dataset.threadId=a.threads[d].id,e.addEventListener("mouseenter",function(){this.classList.add("hover")}),e.addEventListener("mouseleave",function(){this.classList.remove("hover")}),e.addEventListener("click",function(){selectSearchResult(),openThread(this.dataset.threadId),recipientInput.focus()}),a.threads[d].photos.length>1){var f=document.createElement("div");f.classList.add("thumbnailContainer");for(var g=0;g<2;g++){var h=document.createElement("img");a.threads[d].photos[g]?(h.dataset.thumbnailNumber=thumbnailNumber++,Browser.sendToExtension({name:"downloadThumbnail",guid:h.dataset.thumbnailNumber,method:"GET",size:32,url:a.threads[d].photos[g]})):devicePixelRatio>1?h.src=Browser.extension.getURL("images/workchat-no-photo@2x.png"):h.src=Browser.extension.getURL("images/workchat-no-photo.png"),f.appendChild(h)}e.appendChild(f)}else{var h=document.createElement("img");h.classList.add("thumbnail"),a.threads[d].photos[0]?(h.dataset.thumbnailNumber=thumbnailNumber++,Browser.sendToExtension({name:"downloadThumbnail",guid:h.dataset.thumbnailNumber,method:"GET",size:32,url:a.threads[d].photos[0]})):devicePixelRatio>1?h.src=Browser.extension.getURL("images/workchat-no-photo@2x.png"):h.src=Browser.extension.getURL("images/workchat-no-photo.png"),e.appendChild(h)}var i=document.createElement("div");i.classList.add("container");var j=document.createElement("div");j.classList.add("participants");for(var k=[],l=0,g=0;g<a.threads[d].participants.length;g++)a.threads[d].participants[g].name?k.push(a.threads[d].participants[g].name):-1!=a.threads[d].participants[g].id.indexOf("@")?k.push(a.threads[d].participants[g].id):l++;if(l){var m=Browser.plurr.format(Browser.i18n.getMessage("otherParticipants"),{COUNT:l});k.push(m)}a.threads[d].name?j.textContent=a.threads[d].name:j.textContent=k.join(", ");var n=document.createElement("div");n.classList.add("snippet"),n.innerHTML=a.threads[d].snippet||"&nbsp;",i.appendChild(j),i.appendChild(n),e.appendChild(i),suggestedChats.appendChild(e)}hideIfEmpty(suggestedChats),highlightOnlyMatch(),c&&"function"==typeof c&&c()}}function receiveThreadByGivenContacts(a,b,c){a.updateViewNum&&a.updateViewNum<updateViewNum||(a.thread?openThread(a.thread.id):clearSection(selectedThread),c&&"function"==typeof c&&c())}function receiveThumbnail(a,b,c){var d=document.querySelector("img[data-thumbnail-number='"+a.guid+"']");d&&(d.src=a.datauri),c&&"function"==typeof c&&c()}function searchChatsAndContacts(a){a=a.trim(),contactSearchNum=Math.max(contactSearchNum,newestContactSearchReceived)+1,a?Browser.sendToExtension({name:"findWorkchatContacts",query:a,contactSearchNum:contactSearchNum}):(receiveContacts({contacts:[],contactSearchNum:contactSearchNum}),Browser.sendToExtension({name:"getThreads",contactSearchNum:contactSearchNum})),findContacts.classList.add("hasContent")}function selectSearchResult(){newestContactSearchReceived=contactSearchNum+1}function sendChat(){if(!needSendConfirmation()||window.confirm(Browser.i18n.getMessage("bizWorkchatWarning"))){var a={name:"sendChat",body:newMessage.value,threadRecipient:selectedThread.dataset.threadId,contactRecipients:recipientInput.getLozenges(),noteStoreUrl:noteStoreUrl,noteToken:noteToken,noteSharePrivilege:noteShareSelect.getSelected().id};document.body.classList.contains("noShareNote")||(a.attachments=[{guid:noteGuid,shardId:noteShardId,title:noteTitle,userId:noteUserId}],Browser.sendToExtension({name:"trackEvent",category:"Share",action:"workchat_completed",label:a.body?"added_text":"no_text"})),Browser.sendToExtension(a),newMessage.value="",document.body.classList.add("noShareNote"),enableSendButtonIfNeeded(),Browser.sendToExtension({name:"trackEvent",category:"Workchat",action:"sent_message",value:a.contactRecipients.length})}}function setWindowTitle(a){a&&a.trim()?document.title=a.trim():document.title=Browser.i18n.getMessage("share")}function updateEmailContactWithUserId(a,b,c){recipientInput.updateExistingLozenge(a.email,{id:a.user.id,name:a.user.name||a.email,type:ContactType.EVERNOTE}),c&&"function"==typeof c&&c()}function updateView(a,b,c){if(selectedThread.dataset.threadId){var d=selectedThread.lastElementChild?selectedThread.lastElementChild.lastElementChild.dataset.id:0;openThread(selectedThread.dataset.threadId,{afterMessageId:d,updateViewNum:++updateViewNum})}else recipientInput.getLozenges().length&&openThreadWithSelectedContacts({updateViewNum:++updateViewNum});suggestions.classList.contains("hasContent")&&searchChatsAndContacts(recipientInput.input.value),c&&"function"==typeof c&&c()}var recipients,recipientInput,suggestions,suggestedChats,threadInfo,suggestedContacts,contactInfo,findContacts,connectGoogle,selectedThread,messageInfo,originalLastReadMessageId,noteShare,noteShareSelect,newMessage,sendButton,noteGuid,noteTitle,noteShardId,noteUserId,noteToken,notebookType,thumbnailNumber=1,updateViewNum=0,contactSearchNum=0,newestContactSearchReceived=0,MAX_CONTACTS_TO_SHOW=3,PARTICIPANT_CHANGE_EVENTS_COALESCE_TIME_THRESHOLD=3e3,persistThreadReadStatusTimeout;window.addEventListener("beforeunload",function(){Browser.sendToExtension({name:"closeWebSocket"})}),window.addEventListener("DOMContentLoaded",function(){for(var a=/([^=?&]+)=([^&]+)/g,b=a.exec(location.search);b;)"guid"===b[1]?noteGuid=b[2]:"title"===b[1]?noteTitle=decodeURIComponent(b[2]):"shardId"===b[1]?noteShardId=b[2]:"noteStoreUrl"===b[1]?noteStoreUrl=decodeURIComponent(b[2]):"userId"===b[1]?noteUserId=b[2]:"token"===b[1]?noteToken=b[2]:"notebookType"===b[1]&&(notebookType=b[2]),b=a.exec(location.search);noteToken=noteToken||"",recipients=document.getElementById("recipients").lastElementChild,suggestions=document.getElementById("suggestions"),suggestedChats=document.querySelector("#suggestedChats .content"),suggestedContacts=document.querySelector("#suggestedContacts .content"),findContacts=document.getElementById("findContacts"),connectGoogle=document.getElementById("google"),selectedThread=document.getElementById("selectedThread"),noteShare=document.getElementById("noteShare"),newMessage=document.getElementById("newMessage"),sendButton=document.getElementById("sendButton"),recipientInput=new LozengeInput(recipients,Browser.i18n.getMessage("enterNameOrEmail"),searchChatsAndContacts,function(){clearSection(suggestedChats),clearSection(suggestedContacts),hideIfEmpty(suggestedChats),hideIfEmpty(suggestedContacts),hideIfEmpty(findContacts.lastElementChild,!0)},function(){openThreadWithSelectedContacts(),enableSendButtonIfNeeded()},function(a){var b=suggestedContacts.getElementsByClassName("hover")[0];if(b)return b.click(),!1;var c=suggestedChats.getElementsByClassName("hover")[0];return c?(c.click(),!1):!!/^[A-Za-z0-9!#$%&'*+\/=?^_`{|}~-]+(\.[A-Za-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9-]+)*\.([A-Za-z]{2,})$/.test(a)&&(selectSearchResult(),addContact({id:a,type:ContactType.EMAIL}),openThreadWithSelectedContacts(),!1)},function(){var a=suggestedChats.getElementsByClassName("hover")[0]||suggestedContacts.getElementsByClassName("hover")[0];if(a)if(a.classList.remove("hover"),a.previousElementSibling)a.previousElementSibling.classList.add("hover");else{var b=a.parentNode,c=null;c=b===suggestedChats?suggestedContacts:suggestedChats,c.lastElementChild?c.lastElementChild.classList.add("hover"):b.lastElementChild.classList.add("hover")}else{var d=suggestedContacts.lastElementChild||suggestedChats.lastElementChild;d&&d.classList.add("hover")}},function(){var a=suggestedChats.getElementsByClassName("hover")[0]||suggestedContacts.getElementsByClassName("hover")[0];if(a)if(a.classList.remove("hover"),a.nextElementSibling)a.nextElementSibling.classList.add("hover");else{var b=a.parentNode,c=null;c=b===suggestedChats?suggestedContacts:suggestedChats,c.firstElementChild?c.firstElementChild.classList.add("hover"):b.firstElementChild.classList.add("hover")}else{var d=suggestedChats.firstElementChild||suggestedContacts.firstElementChild;d&&d.classList.add("hover")}}),selectedThread.addEventListener("scroll",markVisibleMessagesAsRead),noteShareSelect=new SelectWithLabel(noteShare),noteShareSelect.setLabelName(noteTitle),noteShareSelect.addSelectOption({id:SharedNotePrivilegeLevel.FULL_ACCESS,name:Browser.i18n.getMessage("canEditInvite")}),noteShareSelect.addSelectOption({id:SharedNotePrivilegeLevel.MODIFY_NOTE,name:Browser.i18n.getMessage("canEdit")}),noteShareSelect.addSelectOption({id:SharedNotePrivilegeLevel.READ_NOTE,name:Browser.i18n.getMessage("canView")}),noteShareSelect.setSelected(0),newMessage.placeholder=Browser.i18n.getMessage("typeYourMessage"),newMessage.addEventListener("focus",function(){recipientInput.blurExistingLozenges()}),newMessage.addEventListener("keydown",function(a){13===a.keyCode&&(a.shiftKey||(a.preventDefault(),sendButton.click()))}),newMessage.addEventListener("input",function(){enableSendButtonIfNeeded()}),sendButton.addEventListener("click",sendChat),enableSendButtonIfNeeded(),window.addEventListener("beforeunload",persistThreadReadStatus),GlobalUtils.localize(document.documentElement),setWindowTitle(),Browser.sendToExtension({name:"openWebSocket"}),Browser.sendToExtension({name:"syncMessages",responseName:"messageSyncComplete"}),Browser.sendToExtension({name:"wbg_isGoogleConnected"})}),Browser.addMessageHandlers({isGoogleConnected:isGoogleConnected,messageSyncComplete:messageSyncComplete,receiveContacts:receiveContacts,receiveMessagesOfThread:receiveMessagesOfThread,receiveMetadataOfThread:receiveMetadataOfThread,receiveThreads:receiveThreads,receiveThreadByGivenContacts:receiveThreadByGivenContacts,receiveThumbnail:receiveThumbnail,updateEmailContactWithUserId:updateEmailContactWithUserId,updateView:updateView});